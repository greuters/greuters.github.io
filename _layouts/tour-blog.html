---
layout: default
---
<!--
  Dedicated layout for tour blogs

  - main content is a list of your posts
  - if GPS tracks are available, a map is shown with post-preview images matched along the track by date
  - the content of the overview page using this layout is shown at the bottom of the page

  Requirements for overview page:
  - layout: tour-blog
  - a custom variable 'post_category' with the category of posts that should be listed
  - a custom variable 'init_bounds' with NW and SE corners of the initial region to show;
    format: [[Lat0, Lon0], [Lat1, Lon1]], e.g. [[51, -127], [10, 8]]
  - GPS tracks should be located in assets/tracks/post_category/, each track having a low and a high
    resolution file named according to the following schema: trackNumber_dd-mm-YYYY_vehicle_resolution.gpx
    Example: 0001_17-12-2022_bicycle_highres.gpx, 0001_17-12-2022_bicycle_lowres.gpx
    Vehicle can be one of [bicycle, sail, ferry]
-->

{%- if page.post_category == null -%}
  {{ 'Variable post_category is missing!' | raise_error }}
{%- endif -%}

{%- if page.init_bounds == null -%}
  {{ 'Variable init_bounds is missing!' | raise_error }}
{%- endif -%}

<aside class="map-box">
  <div id="map"></div>
</aside>

<ul id="post-list" class="post-list">
  {%- for post in site.categories[page.post_category] -%}
    <li>
      {%- include post-preview.html post=post -%}
    </li>
  {%- endfor -%}
</ul>

<aside id="overview-content">
  {{ content }}
</aside>

{%- assign highresTrackFiles = site.static_files
  | where_exp: 'file', 'file.path contains "assets/tracks"'
  | where_exp: 'file', 'file.path contains page.post_category'
  | where_exp: 'file', 'file.path contains "highres.gpx"'
-%}
{%- assign tracks = site.emptyArray -%}
{%- for highresTrackFile in highresTrackFiles -%}
  {%- assign lowresTrackFilePath = highresTrackFile.path | replace: 'highres', 'lowres' -%}
  {%- assign lowresTrackFile = site.static_files
    | where_exp: 'file', 'file.path contains lowresTrackFilePath'
    | first
  -%}
  {%- if lowresTrackFile == null -%}
    {{ 'Track file `' | append: lowresTrackFilePath | append: '` is missing!' | raise_error }}
  {%- endif -%}

  {% comment %}
    assuming name format trackNumber_dd-mm-YYYY_vehicle_resolution.gpx
  {% endcomment %}
  {%- assign nameParts = highresTrackFile.name | replace: '.', '_' | split: '_' -%}
  {%- assign trackNumber = nameParts[0] | plus: 0 -%}
  {%- assign dateString = nameParts[1] -%}
  {%- assign vehicle = nameParts[2] -%}
  {%- assign resolution = nameParts[3] -%}
  {%- assign colorIndex = trackNumber | modulo: 2 -%}
  {%- if vehicle == 'bicycle' -%}
    {%- assign colors = 'limegreen green' | split: ' ' -%}
  {%- elsif vehicle == 'sail' -%}
    {%- assign colors = 'dodgerblue navy' | split: ' ' -%}
  {%- elsif vehicle == 'ferry' -%}
    {%- assign colors = 'gray black' | split: ' ' -%}
  {%- else -%}
    {{ 'Unknown vehicle type: ' | append: vehicle | raise_error }}
  {%- endif -%}

  {%- assign trackData = site.emptyArray -%}
  {%- assign trackData = trackData | push: trackNumber -%}
  {%- assign trackData = trackData | push: colors[colorIndex] -%}
  {%- assign trackData = trackData | push: vehicle -%}
  {%- assign trackData = trackData | push: highresTrackFile.path -%}
  {%- assign trackData = trackData | push: lowresTrackFilePath -%}

  {%- assign tracks = tracks | push: trackData -%}
{% endfor %}

<script id="track-data" type="application/json">
  [
    {% for trackData in tracks %}
      {
        "trackNumber": {{trackData[0]}},
        "color": "{{trackData[1]}}",
        "vehicle": "{{trackData[2]}}",
        "highresPath": "{{trackData[3]}}",
        "lowresPath": "{{trackData[4]}}"
      }
      {%- unless trackData == tracks.last -%}
        ,
      {%- endunless -%}
    {% endfor %}
  ]
</script>

{%- if jekyll.environment == 'development' -%}
  {%- assign devMode = 'true' -%}
{%- else -%}
  {%- assign devMode = 'false' -%}
{%- endif -%}
<script
  id="init-map"
  defer
  src="/assets/js/init-map.js"
  type="text/javascript"
  data-dev-mode="{{ devMode }}"
  data-init-bounds="{{ page.init_bounds }}"
  data-view-fullscreen-l10n="{{ site.data[site.active_lang].l10n.viewFullscreen }}"
  data-exit-fullscreen-l10n="{{ site.data[site.active_lang].l10n.exitFullscreen }}"
  data-zoom-in-l10n="{{ site.data[site.active_lang].l10n.zoomIn }}"
  data-zoom-out-l10n="{{ site.data[site.active_lang].l10n.zoomOut }}"
></script>
